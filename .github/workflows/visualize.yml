name: Visualize Latest CFR Results

on:
  workflow_dispatch:

jobs:
  find-latest-cfr-run:
    name: Find Latest CFR Run
    runs-on: ubuntu-latest
    outputs:
      run_number: ${{ steps.get_run.outputs.run_number }}
      run_id: ${{ steps.get_run.outputs.run_id }}
      artifact_name: ${{ steps.get_run.outputs.artifact_name }}

    steps:
      - name: Find latest successful CFR run
        id: get_run
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the latest successful run of "Run CFR Analysis" workflow
          latest_run=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/actions/workflows/run-cfr.yml/runs?status=success&per_page=1" \
            --jq '.workflow_runs[0]')

          run_id=$(echo "$latest_run" | jq -r '.id')
          run_number=$(echo "$latest_run" | jq -r '.run_number')

          if [ "$run_id" = "null" ] || [ -z "$run_id" ]; then
            echo "Error: No successful CFR runs found"
            exit 1
          fi

          artifact_name="cfr-results-${run_number}"

          echo "Found latest successful CFR run:"
          echo "  Run ID: $run_id"
          echo "  Run Number: $run_number"
          echo "  Artifact: $artifact_name"

          echo "run_id=$run_id" >> $GITHUB_OUTPUT
          echo "run_number=$run_number" >> $GITHUB_OUTPUT
          echo "artifact_name=$artifact_name" >> $GITHUB_OUTPUT

  download-cfr-artifact:
    name: Download CFR Artifact
    needs: find-latest-cfr-run
    runs-on: ubuntu-latest

    steps:
      - name: Download artifact from CFR run
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.find-latest-cfr-run.outputs.artifact_name }}
          path: ./cfr-data
          run-id: ${{ needs.find-latest-cfr-run.outputs.run_id }}
          github-token: ${{ github.token }}

      - name: Verify downloaded files
        run: |
          echo "Downloaded CFR artifacts:"
          ls -lh ./cfr-data/
          echo ""
          echo "Checking subdirectories:"
          find ./cfr-data -type f -name "*.nc" | head -20

      - name: Flatten directory structure
        run: |
          echo "Flattening directory structure for presto-viz..."
          # Find all .nc files and move them to cfr-data root
          find ./cfr-data -type f -name "*.nc" -exec mv {} ./cfr-data/ \;
          # Remove empty subdirectories
          find ./cfr-data -type d -empty -delete
          echo ""
          echo "Files after flattening:"
          ls -lh ./cfr-data/

      - name: Re-upload for presto-viz
        uses: actions/upload-artifact@v4
        with:
          name: cfr-data-for-viz-${{ github.run_number }}
          path: ./cfr-data/
          retention-days: 7

  visualize:
    name: Generate Presto Visualization
    needs: [find-latest-cfr-run, download-cfr-artifact]
    # TODO: Switch to fix branch after applying fix to presto-viz - see .github/PRESTO_VIZ_FIX.md
    # uses: DaveEdge1/presto-viz/.github/workflows/presto-viz-reusable.yml@fix/cfr-dimension-order
    uses: DaveEdge1/presto-viz/.github/workflows/presto-viz-reusable.yml@main
    with:
      reconstruction_id: CFR_Run_${{ needs.find-latest-cfr-run.outputs.run_number }}_Reviz_${{ github.run_number }}
      artifact_name: cfr-data-for-viz-${{ github.run_number }}

  deploy-to-github-pages:
    name: Deploy to GitHub Pages
    needs: [find-latest-cfr-run, visualize]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Download visualization artifact
        uses: actions/download-artifact@v4
        with:
          name: presto-viz-output-CFR_Run_${{ needs.find-latest-cfr-run.outputs.run_number }}_Reviz_${{ github.run_number }}
          path: ./visualization-output

      - name: List downloaded files
        run: |
          echo "Downloaded visualization files:"
          ls -lah ./visualization-output/
          find ./visualization-output -type f | head -20

      - name: Save visualization files before git checkout
        run: |
          # Move visualization files to /tmp to preserve them during git checkout
          echo "Moving visualization files to temporary location..."
          mv ./visualization-output /tmp/visualization-output
          echo "Files saved to /tmp/visualization-output"

          # Remove zip files to avoid GitHub's 100MB file size limit
          echo "Removing large zip files..."
          find /tmp/visualization-output -type f -name "*.zip" -delete
          echo "Remaining files for deployment:"
          du -sh /tmp/visualization-output/*

      - name: Setup deployment directory
        run: |
          # Create or switch to gh-pages branch
          git fetch origin gh-pages 2>/dev/null || true
          if git rev-parse --verify origin/gh-pages >/dev/null 2>&1; then
            git checkout gh-pages
            git pull origin gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf . 2>/dev/null || true
          fi

          # Remove old files (keep .git)
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} + 2>/dev/null || true

          # Copy visualization output from temporary location
          echo "Copying visualization files from /tmp..."
          cp -r /tmp/visualization-output/* ./

          # Rename 'viz' directory to 'docs' for GitHub Pages compatibility
          if [ -d "viz" ]; then
            echo "Renaming 'viz' directory to 'docs'..."
            mv viz docs
          fi

          # Create a README
          cat > README.md << 'EOF'
          # CFR Visualization

          **Latest CFR Run**: ${{ needs.find-latest-cfr-run.outputs.run_number }}
          **Visualization Run**: ${{ github.run_number }}
          **Generated**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          This is an automated deployment of Climate Field Reconstruction (CFR) visualization results.

          View the visualization: [https://DaveEdge1.github.io/LMR2/docs/](https://DaveEdge1.github.io/LMR2/docs/)
          EOF

          # List what will be deployed
          echo "Files to be deployed:"
          ls -lah

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push
        run: |
          git add .
          git commit -m "Deploy visualization from CFR run ${{ needs.find-latest-cfr-run.outputs.run_number }} (viz run ${{ github.run_number }})" || echo "No changes to commit"
          git push origin gh-pages

